<html lang="en">
    <head>
        <title>Global animation</title>
        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css"/>
        <style type="text/css">
            body, html {
                width: 100%;
                padding: 0;
                margin: 0;
            }
            #map {
                height: 100%;
                width: 100%;
                background: #fff
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
        <script>
            var map = L.map('map', {
                scrollWheelZoom: true,
                center: [40, 0],
                zoom: 6
            });

            var basemapLayer = {
                user_name: 'solutions',
                type: 'cartodb',
                sublayers: [{
                    sql: "SELECT * FROM spain where description='normal'",
                    cartocss: "" +
                        "#spain{" +
                        "  polygon-fill: #eeeeee;" +
                        "  polygon-opacity: 0.2;" +
                        "  line-color: #000000;" +
                        "  line-width: 0.5;" +
                        "  line-opacity: .2;" +
                        "}"
                }]
            };
            cartodb.createLayer(map, basemapLayer).addTo(map);

            var animatedLayer = {
                user_name: 'solutions',
                type: 'torque',
                options: {
                    query: "" +
                        "SELECT catalonia_elections_twitter_test.* from catalonia_elections_twitter_test " +
                        "JOIN spain_simplified_split " +
                        "ON st_contains(spain_simplified_split.the_geom, catalonia_elections_twitter_test.the_geom)",
                    cartocss: 'Map {-torque-frame-count:512;-torque-animation-duration:30;-torque-time-attribute:"postedtime";-torque-aggregation-function:"CDB_Math_Mode(category_name)";-torque-resolution:2;-torque-data-aggregation:linear}#catalonia_elections_twitter_test{comp-op:lighter;marker-opacity:.2;marker-line-color:#FFF;marker-line-width:0;marker-line-opacity:1;marker-type:ellipse;marker-width:2;marker-fill:#F90}#catalonia_elections_twitter_test::point2[value=1],#catalonia_elections_twitter_test[value=1]{marker-fill:#42a4dc}#catalonia_elections_twitter_test::point2[value=2],#catalonia_elections_twitter_test[value=2]{marker-fill:#ce4039}#catalonia_elections_twitter_test::point2[value=3],#catalonia_elections_twitter_test[value=3]{marker-fill:#4b1e5b}#catalonia_elections_twitter_test::point2[value=4],#catalonia_elections_twitter_test[value=4]{marker-fill:#539147}#catalonia_elections_twitter_test::point2[value=5],#catalonia_elections_twitter_test[value=5]{marker-fill:#FF5C00}#catalonia_elections_twitter_test[value=6]{marker-fill:#EC008C}#catalonia_elections_twitter_test::point2,#catalonia_elections_twitter_test::point3{marker-fill:#229A00;marker-line-color:#fff;marker-line-width:1}#catalonia_elections_twitter_test::point2{marker-width:1;marker-fill-opacity:1;marker-line-opacity:0}#catalonia_elections_twitter_test::point2[value=6]{marker-fill-opacity:0}#catalonia_elections_twitter_test::point3{marker-width:8;marker-fill-opacity:0;marker-line-opacity:.2}#catalonia_elections_twitter_test::3[value=1]{marker-line-color:#5ca2dc}#catalonia_elections_twitter_test::point3[value=2]{marker-line-color:#cd1f25}#catalonia_elections_twitter_test::point3[value=3]{marker-line-color:#aa0028}#catalonia_elections_twitter_test::point3[value=4]{marker-line-color:#593561}#catalonia_elections_twitter_test::point3[value=5]{marker-line-color:#FF5C00}#catalonia_elections_twitter_test::point3[value=6]{marker-line-color:#c3007f}#catalonia_elections_twitter_test[frame-offset=1]{marker-width:3;marker-opacity:.45}#catalonia_elections_twitter_test[frame-offset=2]{marker-width:4;marker-opacity:.225}#catalonia_elections_twitter_test[frame-offset=3]{marker-width:5;marker-opacity:.15}#catalonia_elections_twitter_test[frame-offset=4]{marker-width:6;marker-opacity:.1125}#catalonia_elections_twitter_test[frame-offset=5]{marker-width:7;marker-opacity:.09}#catalonia_elections_twitter_test[frame-offset=6]{marker-width:8;marker-opacity:.075}#catalonia_elections_twitter_test[frame-offset=7]{marker-width:9;marker-opacity:.0642857142857143}#catalonia_elections_twitter_test[frame-offset=8]{marker-width:10;marker-opacity:.05625}#catalonia_elections_twitter_test[frame-offset=9]{marker-width:11;marker-opacity:.05}'
                }
            };
            cartodb.createLayer(map, animatedLayer).addTo(map);
        </script>
    </body>
</html>
