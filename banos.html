<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Tuit Ãºnico</title>
        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css"/>
        <style type="text/css">
            body, html {
                width: 100%;
                padding: 0;
                margin: 0;
            }
            #map {
                height: 100%;
                width: 100%;
                background: #232325;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
        <script>
            function getParameterByName(name) {
                name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
                var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                    results = regex.exec(location.search);
                return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
            }

            var map = L.map('map', {
                scrollWheelZoom: false,
                zoomControl: false,
                center: [39.5, -4.362060546875],
                zoom: getParameterByName('zoom') || 6
            });


            var world = {
                user_name: 'solutions',
                type: 'cartodb',
                sublayers: [{
                    sql: "SELECT * FROM tm_world_borders_0_3 where name NOT LIKE 'Spain'",
                    cartocss: "" +
                        "#tm_world_borders_0_3{" +
                        "  polygon-fill: #0d0d0d;" +
                        "  polygon-opacity: 1;" +
                        "  line-color: #2f2f2f;" +
                        "  line-width: 0.5;" +
                        "  line-opacity: 1;" +
                        "}"
                }]
            };
            cartodb.createLayer(map, world).addTo(map)
            .done(function () {
                var basemapLayer = {
                    user_name: 'solutions',
                    type: 'cartodb',
                    sublayers: [{
                        sql: "SELECT * FROM spain_provinces",
                        cartocss: "" +
                        "#spain_provinces{" +
                        "  polygon-fill: #0d0d0d;" +
                        "  polygon-opacity: 1;" +
                        "  line-color: #2f2f2f;" +
                        "  line-width: 0.5;" +
                        "  line-opacity: 1;" +
                        "}"
                    }]
                };
                cartodb.createLayer(map, basemapLayer).addTo(map)
                .done(function () {
                    var dataLayer = {
                        user_name: 'solutions',
                        type: 'cartodb',
                        sublayers: [{
                            sql: "" +
                            "SELECT ST_Transform(" +
                            "           ST_Segmentize(" +
                            "               ST_MakeLine(" +
                            "                   ST_Transform(the_geom, 953027)," +
                            "                   ST_Transform(ST_SetSRID(ST_MakePoint(2.1487679, 41.39479), 4326), 953027)" +
                            "               )," +
                            "               100000" +
                            "           ), 3857) as the_geom_webmercator, category_name from banos order by cartodb_id limit 5000",
                            cartocss: "" +
                            "#banos{" +
                            "  line-color: #000000;" +
                            "  line-width: 1;" +
                            "  line-opacity: .01;" +
                            "}" +
                            "#banos [ category_name = 1] {" +
                            "  line-color: #FFF;" +
                            "}" +
                            "#banos [ category_name = 2] {" +
                            "  line-color: #FFF;" +
                            "}"
                        }]
                    };
                    cartodb.createLayer(map, dataLayer).addTo(map);
                    setTimeout(function () {
                        var animatedLayer = {
                            user_name: 'solutions',
                            type: 'torque',
                            options: {
                                query: "" +
                                "with lines as (SELECT (random() * 100) as start_step, ST_Transform(" +
                                "           ST_Segmentize(" +
                                "               ST_MakeLine(" +
                                "                   ST_Transform(the_geom, 953027)," +
                                "                   ST_Transform(ST_SetSRID(ST_MakePoint(2.1487679, 41.39479), 4326), 953027)" +
                                "               )," +
                                "               100000" +
                                "           ), 3857) as the_geom_webmercator, category_name from banos order by cartodb_id limit 5000) " +
                                "select ST_Line_Interpolate_Point(lines.the_geom_webmercator," +
                                "    generate_series(0, 100):: double precision / 100" +
                                ") as the_geom_webmercator, (lines.start_step + 100 - generate_series(0, 100)) as step, category_name from lines",
                                cartocss: 'Map {' +
                                '  -torque-frame-count:200;' +
                                '  -torque-animation-duration:10;' +
                                '  -torque-time-attribute:"step";' +
                                '  -torque-aggregation-function:"CDB_Math_Mode(category_name)";' +
                                '  -torque-resolution:2;' +
                                '  -torque-data-aggregation:linear' +
                                '}' +
                                '#banos{' +
                                '  comp-op:screen;' +
                                '  marker-opacity:1;' +
                                '  marker-line-color:#FA3832;' +
                                '  marker-line-width:0;' +
                                '  marker-line-opacity:0;' +
                                '  marker-type:ellipse;' +
                                '  marker-width:1;' +
                                '  marker-fill:#F90' +
                                '}' +
                                '#banos[value=1]{marker-fill:#FA3832}' +
                                '#banos[value=2]{marker-fill:#FA3832}' +
                                '#banos::point{' +
                                '  comp-op:screen;' +
                                '  marker-opacity:.1;' +
                                '  marker-line-color:#FA3832;' +
                                '  marker-line-width:0;' +
                                '  marker-line-opacity:0;' +
                                '  marker-type:ellipse;' +
                                '  marker-width:8;' +
                                '  marker-fill:#FA3832' +
                                '}'
                            }
                        };
                        cartodb.createLayer(map, animatedLayer).addTo(map);
                    },500);
                });
            });
        </script>
    </body>
</html>
